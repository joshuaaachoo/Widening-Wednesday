<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Widening Wednesday</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .slideshow-container {
            position: relative;
            width: 370px;
            margin: 0 auto 40px auto;
            min-height: 480px;
            display: flex;
            align-items: center;
            justify-content: center;
            perspective: 1200px;
            user-select: none;
        }

        .slideshow-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(35,37,38,0.85);
            border: none;
            color: #fff;
            font-size: 2.2rem;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            cursor: pointer;
            z-index: 2;
            transition: background 0.2s;
        }
        .slideshow-arrow:hover {
            background: #1DB954;
            color: #fff;
        }
        .slideshow-arrow.left {
            left: -60px;
        }
        .slideshow-arrow.right {
            right: -60px;
        }
        .slideshow-cards {
            width: 100%;
            height: 100%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .slideshow-card {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.6s cubic-bezier(.25,.8,.25,1), opacity 0.6s cubic-bezier(.25,.8,.25,1), z-index 0s;
            will-change: transform, opacity;
        }

        .song-card {
            background: #232526;
            border-radius: 24px;
            padding: 0;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            transition: transform 0.3s cubic-bezier(.25,.8,.25,1), box-shadow 0.3s cubic-bezier(.25,.8,.25,1);
            position: relative;
            overflow: hidden;
            width: 340px;
            min-height: 420px;
            display: flex;
            flex-direction: column;
            border: 1.5px solid rgba(255,255,255,0.08);
        }

        .song-card:hover {
            transform: translateY(-8px) scale(1.03);
            box-shadow: 0 20px 50px rgba(0,0,0,0.35);
        }

        .song-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 8px;
            background: linear-gradient(90deg, #1DB954, #1ed760);
        }

        .song-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 0;
            position: relative;
            padding: 0;
        }

        .song-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 0 0 18px 18px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.18);
            margin: 0;
        }

        .song-details h3 {
            font-size: 1.25rem;
            margin-bottom: 4px;
            color: #fff;
            font-weight: 700;
            letter-spacing: 0.01em;
        }

        .song-details h3 a {
            color: #1DB954;
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .song-details h3 a:hover {
            color: #1ed760;
            text-decoration: underline;
        }

        .song-details p {
            color: #bdbdbd;
            font-size: 1rem;
            margin-bottom: 0.5em;
        }

        .rating-section {
            margin-bottom: 16px;
            margin-top: 18px;
        }

        .rating-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #fff;
        }

        .rating-input {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .rating-slider {
            flex: 1;
            height: 8px;
            border-radius: 4px;
            background: #444;
            outline: none;
            appearance: none;
            -webkit-appearance: none;
        }

        .rating-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1DB954, #1ed760);
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.22);
            border: 2px solid #fff;
        }

        .rating-slider::-moz-range-thumb {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1DB954, #1ed760);
            cursor: pointer;
            border: 2px solid #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.22);
        }

        .rating-value {
            font-weight: bold;
            font-size: 1.2rem;
            color: #1DB954;
            min-width: 30px;
            text-align: center;
        }

        .review-section {
            margin-bottom: 16px;
        }

        .review-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #333;
            background: #18191a;
            color: #fff;
            border-radius: 10px;
            font-family: inherit;
            font-size: 0.95rem;
            resize: vertical;
            min-height: 80px;
            transition: border-color 0.3s ease;
        }

        .review-textarea:focus {
            outline: none;
            border-color: #1DB954;
        }

        .submit-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #1DB954, #1ed760);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            margin-top: 10px;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(29, 185, 84, 0.4);
        }

        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .stats {
            display: flex;
            justify-content: flex-end;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #333;
            font-size: 0.92rem;
            color: #bdbdbd;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 1.2rem;
        }

        .loading i {
            font-size: 2rem;
            margin-bottom: 10px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: white;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.7;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .empty-state p {
            font-size: 1.1rem;
            opacity: 0.8;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #c3e6cb;
            display: none;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #f5c6cb;
            display: none;
        }

        .user-rating-info {
            background: #1DB95422;
            color: #1DB954;
            padding: 10px 15px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid #1DB95444;
            font-size: 0.95rem;
            display: none;
        }

        .user-rating-info i {
            margin-right: 5px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            .header h1 {
                font-size: 2rem;
            }
            .songs-grid {
                flex-direction: column;
                gap: 20px;
            }
            .song-card {
                width: 100%;
                min-width: 0;
                min-height: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Widening Wednesday</h1>
            <p>Rate the songs shared every Wednesday!</p>
            <div id="userAuth" style="margin-top:20px;"></div>
        </div>

        <canvas class="webgl-canvas" style="width:100%;height:400px;display:block;border-radius:24px;"></canvas>
        <div id="slideInfo" class="slide-info-overlay"></div>
        <div class="slideshow-controls" style="display:flex;justify-content:center;align-items:center;margin:30px 0 10px 0;gap:30px;">
            <button id="slidePrev" class="slideshow-arrow left" aria-label="Previous song"><i class="fas fa-chevron-left"></i></button>
            <div class="slide-counter"><span id="slideCounter">01</span>/<span id="slideTotal">01</span></div>
            <button id="slideNext" class="slideshow-arrow right" aria-label="Next song"><i class="fas fa-chevron-right"></i></button>
        </div>
        <div id="slidesNav" class="slides-nav" style="display:flex;justify-content:center;gap:10px;"></div>
    </div>

    <script>
        let currentUser = null;
        async function fetchUser() {
            try {
                const res = await fetch('/api/me');
                if (res.ok) {
                    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
                    <script src="/public/slideshow.js"></script>
                            <h3><a href="${song.spotify_url}" target="_blank">${song.title || 'Unknown Title'}</a></h3>
                            <p>${song.artist || 'Unknown Artist'}</p>
                        </div>
                    </div>
                    <div class="rating-section" style="padding: 0 22px;">
                        ${loginMsg}
                        <label class="rating-label">Rate this song (1-7):</label>
                        <div class="rating-input">
                            <input type="range" 
                                   class="rating-slider" 
                                   min="1" 
                                   max="7" 
                                   value="4" 
                                   data-song-id="${song.id}"
                                   oninput="this.nextElementSibling.textContent = this.value"
                                   ${disabled}>
                            <span class="rating-value">4</span>
                        </div>
                    </div>
                    <div class="review-section" style="padding: 0 22px;">
                        <label class="rating-label">Optional Review:</label>
                        <textarea class="review-textarea" 
                                  placeholder="Share your thoughts about this song..." 
                                  data-song-id="${song.id}" ${disabled}></textarea>
                    </div>
                    <div style="flex:1;"></div>
                    <button class="submit-btn" onclick="rater.submitRating(${song.id})" ${disabled}>
                        <i class="fas fa-star"></i> Submit Rating
                    </button>
                    <div class="stats">
                        <span><i class="fas fa-users"></i> ${ratingCount} rating${ratingCount !== 1 ? 's' : ''}</span>
                    </div>
                    <div class="success-message" id="success-${song.id}">
                        <i class="fas fa-check-circle"></i> Rating submitted successfully!
                    </div>
                    <div class="error-message" id="error-${song.id}">
                        <i class="fas fa-exclamation-circle"></i> <span class="error-text"></span>
                    </div>
                    <div class="user-rating-info" id="user-rating-${song.id}">
                        <i class="fas fa-check-circle"></i> <span class="rating-text"></span>
                    </div>
                </div>
                `;
            }

            async submitRating(songId) {
                if (!currentUser) {
                    alert('You must be logged in with Discord to rate.');
                    return;
                }
                const card = document.querySelector(`[data-song-id="${songId}"]`);
                const ratingSlider = card.querySelector('.rating-slider');
                const reviewTextarea = card.querySelector('.review-textarea');
                const submitBtn = card.querySelector('.submit-btn');
                const successMsg = card.querySelector('.success-message');
                const errorMsg = card.querySelector('.error-message');

                const rating = parseInt(ratingSlider.value);
                const review = reviewTextarea.value.trim();

                // Disable button and show loading
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
                this.hideMessages(songId);

                try {
                    const response = await fetch(`/api/songs/${songId}/rate`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            user_id: currentUser.id,
                            rating: rating,
                            review: review || null
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        successMsg.innerHTML = `<i class="fas fa-check-circle"></i> Rating ${result.updated ? 'updated' : 'submitted'} successfully!`;
                        successMsg.style.display = 'block';
                        // Clear form
                        ratingSlider.value = 4;
                        ratingSlider.nextElementSibling.textContent = '4';
                        reviewTextarea.value = '';
                        // Update user rating info
                        await this.checkUserRating(songId);
                        // Reload songs to update stats
                        setTimeout(() => this.loadSongs(), 1000);
                    } else {
                        const errorData = await response.json();
                        this.showError(songId, errorData.error || 'Failed to submit rating');
                    }
                } catch (error) {
                    console.error('Error submitting rating:', error);
                    this.showError(songId, 'Network error. Please try again.');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-star"></i> Submit Rating';
                }
            }

            showError(songId, message) {
                const errorMsg = document.getElementById(`error-${songId}`);
                const errorText = errorMsg.querySelector('.error-text');
                errorText.textContent = message;
                errorMsg.style.display = 'block';
            }

            hideMessages(songId) {
                const successMsg = document.getElementById(`success-${songId}`);
                const errorMsg = document.getElementById(`error-${songId}`);
                successMsg.style.display = 'none';
                errorMsg.style.display = 'none';
            }

            async checkUserRating(songId) {
                try {
                    const response = await fetch(`/api/songs/${songId}/ratings`);
                    const ratings = await response.json();
                    // Find if current user has rated
                    if (!currentUser) return;
                    const userRating = ratings.find(r => r.user_id === currentUser.id);
                    if (userRating) {
                        const userRatingInfo = document.getElementById(`user-rating-${songId}`);
                        const ratingText = userRatingInfo.querySelector('.rating-text');
                        const timestamp = this.formatTimestamp(userRating.created_at);
                        ratingText.textContent = `You rated this ${userRating.rating}/7 ${timestamp}`;
                        userRatingInfo.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Error checking user rating:', error);
                }
            }

            formatTimestamp(timestamp) {
                const date = new Date(timestamp);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);
                if (diffMins < 1) return 'just now';
                if (diffMins < 60) return `${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`;
                if (diffHours < 24) return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
                if (diffDays < 7) return `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
                return 'on ' + date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            }

            setupAutoRefresh() {
                setInterval(() => {
                    this.loadSongs();
                }, 30000);
            }
        }

    // Initialize the app
    const rater = new SpotifyRater();
    </script>
</body>
</html>
